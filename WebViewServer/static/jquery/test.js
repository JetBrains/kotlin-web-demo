$(document).ready(function () {

    var i = 'import java.util.*<br><br>namespace html {<br><br>  abstract class Factory<T> {<br>    abstract fun create() : T<br>  }<br><br>  abstract class Element<br><br>  class TextElement(val text : String) : Element<br><br>  abstract class Tag(val name : String) : Element {<br>    val children = ArrayList<Element>()<br>    val attributes = HashMap<String, String>()<br><br>    protected fun initTag<T : Element>(init : fun T.() : Unit) : T<br>      where class object T : Factory<T>{<br>      val tag = T.create()<br>      tag.init()<br>      children.add(tag)<br>      return tag<br>    }<br>  }<br><br>  abstract class TagWithText(name : String) : Tag(name) {<br>    fun String.plus() {<br>      children.add(TextElement(this))<br>    }<br>  }<br><br>  class HTML() : TagWithText("html") {<br>    class object : Factory<HTML> {<br>      override fun create() = HTML()<br>    }<br><br>    fun head(init : fun Head.() : Unit) = initTag<Head>(init)<br><br>    fun body(init : fun Body.() : Unit) = initTag<Body>(init)<br>  }<br><br>  class Head() : TagWithText("head") {<br>    class object : Factory<Head> {<br>      override fun create() = Head()<br>    }<br><br>    fun title(init : fun Title.() : Unit) = initTag<Title>(init)<br>  }<br><br>  class Title() : TagWithText("title")<br><br>  abstract class BodyTag(name : String) : TagWithText(name) {<br>  }<br><br>  class Body() : BodyTag("body") {<br>    class object : Factory<Body> {<br>      override fun create() = Body()<br>    }<br><br>    fun b(init : fun B.() : Unit) = initTag<B>(init)<br>    fun p(init : fun P.() : Unit) = initTag<P>(init)<br>    fun h1(init : fun H1.() : Unit) = initTag<H1>(init)<br>    fun a(href : String, init : fun A.() : Unit) {<br>      val a = initTag<A>(init)<br>      a.href = href<br>    }<br>  }<br><br>  class B() : BodyTag("b")<br>  class P() : BodyTag("p")<br>  class H1() : BodyTag("h1")<br>  class A() : BodyTag("a") {<br>    var href : String<br>      get() = attributes["href"]<br>      set(value) { attributes["href"] = value }<br>  }<br><br>  fun Map<String, String>.set(key : String, value : String) = this.put(key, value)<br><br>  fun html(init : fun HTML.() : Unit) : HTML {<br>    val html = HTML()<br>    html.init()<br>    return html<br>  }<br><br>}<br><br>namespace foo {<br><br>import html.*<br><br>fun result(args : Array<String>) =<br>  html {<br>    head {<br>      title {+"XML encoding with Groovy"}<br>    }<br>    body {<br>      h1 {+"XML encoding with Groovy"}<br>      p {+"this format can be used as an alternative markup to XML"}<br><br>      // an element with attributes and text content<br>      a(href = "http://groovy.codehaus.org") {+"Groovy"}<br><br>      // mixed content<br>      p {<br>        +"This is some"<br>        b {+"mixed"}<br>        +"text. For more see the"<br>        a(href = "http://groovy.codehaus.org") {+"Groovy"}<br>        +"project"<br>      }<br>      p {+"some text"}<br><br>      // content generated by<br>      p {<br>        for (arg in args)<br>          +arg<br>      }<br>    }<br>  }<br>}<br>';
    var isStop = false;
    /*function sendDataToServer() {
     $.ajax({
     url:document.location.href + "?stopTest=true",
     type:"POST",
     data:{text:result},
     success:onLoad
     });
     result = "";
     }*/

    function getHighlighting() {
        $.ajax({
            url: generateAjaxUrl("highlight", "null"),
            type:"POST",
            data:{text:i},
            complete:onLoadHighlighting
        });
    }

    function onLoadHighlighting() {
        if (!isStop) {
            getApplet();
        }
    }

    function getApplet() {
//        var url = document.location.href;
//        url = url.replace("testConnection", "WebViewApplet.jar");
        var url = [location.protocol, '//', location.host, location.pathname].join('') + "/WebViewApplet.jar";
        $.ajax({
            url:url,
            type:"GET",
            complete:onLoadApplet
        });
    }

    function onLoadApplet() {
        if (!isStop) {
            getCompletion();
        }
    }

    function getCompletion() {
        $.ajax({
            url: generateAjaxUrl("complete", "27,15"),
            type:"POST",
            data:{text:i},
            complete:onLoadCompletion
        });
    }

    function onLoadCompletion() {
        if (!isStop) {
            getHighlighting();
        }
    }

    $('#stopH').click(function () {
        isStop = true;
    });

    $('#startH').click(function () {
        getHighlighting();
        isStop = false;
    });
});